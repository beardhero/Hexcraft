"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MapSchema = exports.getMapProxy = void 0;
var ChangeTree_1 = require("../changes/ChangeTree");
var spec_1 = require("../spec");
var Schema_1 = require("../Schema");
var _1 = require(".");
function getMapProxy(value) {
    value['$proxy'] = true;
    value = new Proxy(value, {
        get: function (obj, prop) {
            if (typeof (prop) !== "symbol" && // accessing properties
                typeof (obj[prop]) === "undefined") {
                return obj.get(prop);
            }
            else {
                return obj[prop];
            }
        },
        set: function (obj, prop, setValue) {
            if (typeof (prop) !== "symbol" &&
                (prop.indexOf("$") === -1 &&
                    prop !== "onAdd" &&
                    prop !== "onRemove" &&
                    prop !== "onChange")) {
                obj.set(prop, setValue);
            }
            else {
                obj[prop] = setValue;
            }
            return true;
        },
        deleteProperty: function (obj, prop) {
            obj.delete(prop);
            return true;
        },
    });
    return value;
}
exports.getMapProxy = getMapProxy;
var MapSchema = /** @class */ (function () {
    function MapSchema(initialValues) {
        var _this = this;
        this.$changes = new ChangeTree_1.ChangeTree(this);
        this.$items = new Map();
        this.$indexes = new Map();
        this.$refId = 0;
        if (initialValues) {
            if (initialValues instanceof Map) {
                initialValues.forEach(function (v, k) { return _this.set(k, v); });
            }
            else {
                for (var k in initialValues) {
                    this.set(k, initialValues[k]);
                }
            }
        }
    }
    MapSchema.is = function (type) {
        return type['map'] !== undefined;
    };
    /** Iterator */
    MapSchema.prototype[Symbol.iterator] = function () { return this.$items[Symbol.iterator](); };
    Object.defineProperty(MapSchema.prototype, Symbol.toStringTag, {
        get: function () { return this.$items[Symbol.toStringTag]; },
        enumerable: false,
        configurable: true
    });
    MapSchema.prototype.set = function (key, value) {
        // get "index" for this value.
        var hasIndex = typeof (this.$changes.indexes[key]) !== "undefined";
        var index = (hasIndex)
            ? this.$changes.indexes[key]
            : this.$refId++;
        var operation = (hasIndex)
            ? spec_1.OPERATION.REPLACE
            : spec_1.OPERATION.ADD;
        var isRef = (value['$changes']) !== undefined;
        if (isRef) {
            value['$changes'].setParent(this, this.$changes.root, index);
        }
        //
        // (encoding)
        // set a unique id to relate directly with this key/value.
        //
        if (!hasIndex) {
            this.$changes.indexes[key] = index;
            this.$indexes.set(index, key);
        }
        else if (isRef && // if is schema, force ADD operation if value differ from previous one.
            this.$items.get(key) !== value) {
            operation = spec_1.OPERATION.ADD;
        }
        this.$items.set(key, value);
        this.$changes.change(key, operation);
        return this;
    };
    MapSchema.prototype.get = function (key) {
        return this.$items.get(key);
    };
    MapSchema.prototype.delete = function (key) {
        //
        // TODO: add a "purge" method after .encode() runs, to cleanup removed `$indexes`
        //
        // We don't remove $indexes to allow setting the same key in the same patch
        // (See "should allow to remove and set an item in the same place" test)
        //
        // // const index = this.$changes.indexes[key];
        // // this.$indexes.delete(index);
        this.$changes.delete(key);
        return this.$items.delete(key);
    };
    MapSchema.prototype.clear = function (isDecoding) {
        var _this = this;
        // discard previous operations.
        this.$changes.discard(true);
        this.$changes.indexes = {};
        // clear previous indexes
        this.$indexes.clear();
        // flag child items for garbage collection.
        if (isDecoding && typeof (this.$changes.getType()) !== "string") {
            this.$items.forEach(function (item) {
                _this.$changes.root.removeRef(item['$changes'].refId);
            });
        }
        // clear items
        this.$items.clear();
        this.$changes.operation({ index: 0, op: spec_1.OPERATION.CLEAR });
        // touch all structures until reach root
        this.$changes.touchParents();
    };
    MapSchema.prototype.has = function (key) {
        return this.$items.has(key);
    };
    MapSchema.prototype.forEach = function (callbackfn) {
        this.$items.forEach(callbackfn);
    };
    MapSchema.prototype.entries = function () {
        return this.$items.entries();
    };
    MapSchema.prototype.keys = function () {
        return this.$items.keys();
    };
    MapSchema.prototype.values = function () {
        return this.$items.values();
    };
    Object.defineProperty(MapSchema.prototype, "size", {
        get: function () {
            return this.$items.size;
        },
        enumerable: false,
        configurable: true
    });
    MapSchema.prototype.setIndex = function (index, key) {
        this.$indexes.set(index, key);
    };
    MapSchema.prototype.getIndex = function (index) {
        return this.$indexes.get(index);
    };
    MapSchema.prototype.getByIndex = function (index) {
        return this.$items.get(this.$indexes.get(index));
    };
    MapSchema.prototype.deleteByIndex = function (index) {
        var key = this.$indexes.get(index);
        this.$items.delete(key);
        this.$indexes.delete(index);
    };
    MapSchema.prototype.toJSON = function () {
        var map = {};
        this.forEach(function (value, key) {
            map[key] = (typeof (value['toJSON']) === "function")
                ? value['toJSON']()
                : value;
        });
        return map;
    };
    //
    // Decoding utilities
    //
    MapSchema.prototype.clone = function (isDecoding) {
        var cloned;
        if (isDecoding) {
            // client-side
            cloned = Object.assign(new MapSchema(), this);
        }
        else {
            // server-side
            var cloned_1 = new MapSchema();
            this.forEach(function (value, key) {
                if (value['$changes']) {
                    cloned_1.set(key, value['clone']());
                }
                else {
                    cloned_1.set(key, value);
                }
            });
        }
        return cloned;
    };
    MapSchema.prototype.triggerAll = function () {
        Schema_1.Schema.prototype.triggerAll.apply(this);
    };
    return MapSchema;
}());
exports.MapSchema = MapSchema;
_1.registerType("map", {
    constructor: MapSchema,
    getProxy: getMapProxy,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFwU2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3R5cGVzL01hcFNjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxvREFBbUQ7QUFDbkQsZ0NBQW9DO0FBQ3BDLG9DQUEyRDtBQUMzRCxzQkFBaUM7QUFJakMsU0FBZ0IsV0FBVyxDQUFDLEtBQWdCO0lBQ3hDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUM7SUFFdkIsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssRUFBRTtRQUNyQixHQUFHLEVBQUUsVUFBQyxHQUFHLEVBQUUsSUFBSTtZQUNYLElBQ0ksT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLFFBQVEsSUFBSSx1QkFBdUI7Z0JBQ3JELE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxXQUFXLEVBQ3BDO2dCQUNFLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFjLENBQUMsQ0FBQzthQUVsQztpQkFBTTtnQkFDSCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNwQjtRQUNMLENBQUM7UUFFRCxHQUFHLEVBQUUsVUFBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLFFBQVE7WUFDckIsSUFDSSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssUUFBUTtnQkFDMUIsQ0FDSyxJQUFlLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDcEMsSUFBSSxLQUFLLE9BQU87b0JBQ2hCLElBQUksS0FBSyxVQUFVO29CQUNuQixJQUFJLEtBQUssVUFBVSxDQUN0QixFQUNIO2dCQUNFLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBYyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBRXJDO2lCQUFNO2dCQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7YUFDeEI7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FB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LEVBQUUsSUFBSSxDQUFDLENBQUM7U0FFakQ7YUFBTTtZQUNILGNBQWM7WUFDZCxJQUFNLFFBQU0sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFLLEVBQUUsR0FBRztnQkFDcEIsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLEVBQUU7b0JBQ25CLFFBQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ3JDO3FCQUFNO29CQUNILFFBQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO2lCQUMxQjtZQUNMLENBQUMsQ0FBQyxDQUFBO1NBQ0w7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsOEJBQVUsR0FBVjtRQUNJLGVBQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBQ0wsZ0JBQUM7QUFBRCxDQUFDLEFBMU1ELElBME1DO0FBMU1ZLDhCQUFTO0FBNE10QixlQUFZLENBQUMsS0FBSyxFQUFFO0lBQ2hCLFdBQVcsRUFBRSxTQUFTO0lBQ3RCLFFBQVEsRUFBRSxXQUFXO0NBQ3hCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZVRyZWUgfSBmcm9tIFwiLi4vY2hhbmdlcy9DaGFuZ2VUcmVlXCI7XG5pbXBvcnQgeyBPUEVSQVRJT04gfSBmcm9tIFwiLi4vc3BlY1wiO1xuaW1wb3J0IHsgU2NoZW1hRGVjb2RlckNhbGxiYWNrcywgU2NoZW1hIH0gZnJvbSBcIi4uL1NjaGVtYVwiO1xuaW1wb3J0IHsgcmVnaXN0ZXJUeXBlIH0gZnJvbSBcIi5cIjtcblxudHlwZSBLID0gc3RyaW5nOyAvLyBUT0RPOiBhbGxvdyB0byBzcGVjaWZ5IEsgZ2VuZXJpYyBvbiBNYXBTY2hlbWEuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNYXBQcm94eSh2YWx1ZTogTWFwU2NoZW1hKSB7XG4gICAgdmFsdWVbJyRwcm94eSddID0gdHJ1ZTtcblxuICAgIHZhbHVlID0gbmV3IFByb3h5KHZhbHVlLCB7XG4gICAgICAgIGdldDogKG9iaiwgcHJvcCkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIHR5cGVvZiAocHJvcCkgIT09IFwic3ltYm9sXCIgJiYgLy8gYWNjZXNzaW5nIHByb3BlcnRpZXNcbiAgICAgICAgICAgICAgICB0eXBlb2YgKG9ialtwcm9wXSkgPT09IFwidW5kZWZpbmVkXCJcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHJldHVybiBvYmouZ2V0KHByb3AgYXMgc3RyaW5nKTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2JqW3Byb3BdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIHNldDogKG9iaiwgcHJvcCwgc2V0VmFsdWUpID0+IHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICB0eXBlb2YgKHByb3ApICE9PSBcInN5bWJvbFwiICYmXG4gICAgICAgICAgICAgICAgKFxuICAgICAgICAgICAgICAgICAgICAocHJvcCBhcyBzdHJpbmcpLmluZGV4T2YoXCIkXCIpID09PSAtMSAmJlxuICAgICAgICAgICAgICAgICAgICBwcm9wICE9PSBcIm9uQWRkXCIgJiZcbiAgICAgICAgICAgICAgICAgICAgcHJvcCAhPT0gXCJvblJlbW92ZVwiICYmXG4gICAgICAgICAgICAgICAgICAgIHByb3AgIT09IFwib25DaGFuZ2VcIlxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIG9iai5zZXQocHJvcCBhcyBzdHJpbmcsIHNldFZhbHVlKTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvYmpbcHJvcF0gPSBzZXRWYWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LFxuXG4gICAgICAgIGRlbGV0ZVByb3BlcnR5OiAob2JqLCBwcm9wKSA9PiB7XG4gICAgICAgICAgICBvYmouZGVsZXRlKHByb3AgYXMgc3RyaW5nKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHZhbHVlO1xufVxuXG5leHBvcnQgY2xhc3MgTWFwU2NoZW1hPFY9YW55PiBpbXBsZW1lbnRzIE1hcDxzdHJpbmcsIFY+LCBTY2hlbWFEZWNvZGVyQ2FsbGJhY2tzIHtcbiAgICBwcm90ZWN0ZWQgJGNoYW5nZXM6IENoYW5nZVRyZWUgPSBuZXcgQ2hhbmdlVHJlZSh0aGlzKTtcblxuICAgIHByb3RlY3RlZCAkaXRlbXM6IE1hcDxzdHJpbmcsIFY+ID0gbmV3IE1hcDxzdHJpbmcsIFY+KCk7XG4gICAgcHJvdGVjdGVkICRpbmRleGVzOiBNYXA8bnVtYmVyLCBzdHJpbmc+ID0gbmV3IE1hcDxudW1iZXIsIHN0cmluZz4oKTtcblxuICAgIHByb3RlY3RlZCAkcmVmSWQ6IG51bWJlciA9IDA7XG5cbiAgICAvL1xuICAgIC8vIERlY29kaW5nIGNhbGxiYWNrc1xuICAgIC8vXG4gICAgcHVibGljIG9uQWRkPzogKGl0ZW06IFYsIGtleTogc3RyaW5nKSA9PiB2b2lkO1xuICAgIHB1YmxpYyBvblJlbW92ZT86IChpdGVtOiBWLCBrZXk6IHN0cmluZykgPT4gdm9pZDtcbiAgICBwdWJsaWMgb25DaGFuZ2U/OiAoaXRlbTogViwga2V5OiBzdHJpbmcpID0+IHZvaWQ7XG5cbiAgICBzdGF0aWMgaXModHlwZTogYW55KSB7XG4gICAgICAgIHJldHVybiB0eXBlWydtYXAnXSAhPT0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yIChpbml0aWFsVmFsdWVzPzogTWFwPHN0cmluZywgVj4gfCBhbnkpIHtcbiAgICAgICAgaWYgKGluaXRpYWxWYWx1ZXMpIHtcbiAgICAgICAgICAgIGlmIChpbml0aWFsVmFsdWVzIGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICAgICAgICAgICAgaW5pdGlhbFZhbHVlcy5mb3JFYWNoKCh2LCBrKSA9PiB0aGlzLnNldChrLCB2KSk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBrIGluIGluaXRpYWxWYWx1ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXQoaywgaW5pdGlhbFZhbHVlc1trXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIEl0ZXJhdG9yICovXG4gICAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxbSywgVl0+IHsgcmV0dXJuIHRoaXMuJGl0ZW1zW1N5bWJvbC5pdGVyYXRvcl0oKTsgfVxuICAgIGdldCBbU3ltYm9sLnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIHRoaXMuJGl0ZW1zW1N5bWJvbC50b1N0cmluZ1RhZ10gfVxuXG4gICAgc2V0KGtleTogSywgdmFsdWU6IFYpIHtcbiAgICAgICAgLy8gZ2V0IFwiaW5kZXhcIiBmb3IgdGhpcyB2YWx1ZS5cbiAgICAgICAgY29uc3QgaGFzSW5kZXggPSB0eXBlb2YodGhpcy4kY2hhbmdlcy5pbmRleGVzW2tleV0pICE9PSBcInVuZGVmaW5lZFwiO1xuICAgICAgICBjb25zdCBpbmRleCA9IChoYXNJbmRleClcbiAgICAgICAgICAgID8gdGhpcy4kY2hhbmdlcy5pbmRleGVzW2tleV1cbiAgICAgICAgICAgIDogdGhpcy4kcmVmSWQrKztcblxuICAgICAgICBsZXQgb3BlcmF0aW9uOiBPUEVSQVRJT04gPSAoaGFzSW5kZXgpXG4gICAgICAgICAgICA/IE9QRVJBVElPTi5SRVBMQUNFXG4gICAgICAgICAgICA6IE9QRVJBVElPTi5BREQ7XG5cbiAgICAgICAgY29uc3QgaXNSZWYgPSAodmFsdWVbJyRjaGFuZ2VzJ10pICE9PSB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChpc1JlZikge1xuICAgICAgICAgICAgKHZhbHVlWyckY2hhbmdlcyddIGFzIENoYW5nZVRyZWUpLnNldFBhcmVudChcbiAgICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICAgIHRoaXMuJGNoYW5nZXMucm9vdCxcbiAgICAgICAgICAgICAgICBpbmRleFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIC8vIChlbmNvZGluZylcbiAgICAgICAgLy8gc2V0IGEgdW5pcXVlIGlkIHRvIHJlbGF0ZSBkaXJlY3RseSB3aXRoIHRoaXMga2V5L3ZhbHVlLlxuICAgICAgICAvL1xuICAgICAgICBpZiAoIWhhc0luZGV4KSB7XG4gICAgICAgICAgICB0aGlzLiRjaGFuZ2VzLmluZGV4ZXNba2V5XSA9IGluZGV4O1xuICAgICAgICAgICAgdGhpcy4kaW5kZXhlcy5zZXQoaW5kZXgsIGtleSk7XG5cbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICAgIGlzUmVmICYmIC8vIGlmIGlzIHNjaGVtYSwgZm9yY2UgQUREIG9wZXJhdGlvbiBpZiB2YWx1ZSBkaWZmZXIgZnJvbSBwcmV2aW91cyBvbmUuXG4gICAgICAgICAgICB0aGlzLiRpdGVtcy5nZXQoa2V5KSAhPT0gdmFsdWVcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBvcGVyYXRpb24gPSBPUEVSQVRJT04uQUREO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy4kaXRlbXMuc2V0KGtleSwgdmFsdWUpO1xuXG4gICAgICAgIHRoaXMuJGNoYW5nZXMuY2hhbmdlKGtleSwgb3BlcmF0aW9uKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBnZXQoa2V5OiBLKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy5nZXQoa2V5KTtcbiAgICB9XG5cbiAgICBkZWxldGUoa2V5OiBLKSB7XG4gICAgICAgIC8vXG4gICAgICAgIC8vIFRPRE86IGFkZCBhIFwicHVyZ2VcIiBtZXRob2QgYWZ0ZXIgLmVuY29kZSgpIHJ1bnMsIHRvIGNsZWFudXAgcmVtb3ZlZCBgJGluZGV4ZXNgXG4gICAgICAgIC8vXG4gICAgICAgIC8vIFdlIGRvbid0IHJlbW92ZSAkaW5kZXhlcyB0byBhbGxvdyBzZXR0aW5nIHRoZSBzYW1lIGtleSBpbiB0aGUgc2FtZSBwYXRjaFxuICAgICAgICAvLyAoU2VlIFwic2hvdWxkIGFsbG93IHRvIHJlbW92ZSBhbmQgc2V0IGFuIGl0ZW0gaW4gdGhlIHNhbWUgcGxhY2VcIiB0ZXN0KVxuICAgICAgICAvL1xuICAgICAgICAvLyAvLyBjb25zdCBpbmRleCA9IHRoaXMuJGNoYW5nZXMuaW5kZXhlc1trZXldO1xuICAgICAgICAvLyAvLyB0aGlzLiRpbmRleGVzLmRlbGV0ZShpbmRleCk7XG5cbiAgICAgICAgdGhpcy4kY2hhbmdlcy5kZWxldGUoa2V5KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmRlbGV0ZShrZXkpO1xuICAgIH1cblxuICAgIGNsZWFyKGlzRGVjb2Rpbmc/OiBib29sZWFuKSB7XG4gICAgICAgIC8vIGRpc2NhcmQgcHJldmlvdXMgb3BlcmF0aW9ucy5cbiAgICAgICAgdGhpcy4kY2hhbmdlcy5kaXNjYXJkKHRydWUpO1xuICAgICAgICB0aGlzLiRjaGFuZ2VzLmluZGV4ZXMgPSB7fTtcblxuICAgICAgICAvLyBjbGVhciBwcmV2aW91cyBpbmRleGVzXG4gICAgICAgIHRoaXMuJGluZGV4ZXMuY2xlYXIoKTtcblxuICAgICAgICAvLyBmbGFnIGNoaWxkIGl0ZW1zIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24uXG4gICAgICAgIGlmIChpc0RlY29kaW5nICYmIHR5cGVvZiAodGhpcy4kY2hhbmdlcy5nZXRUeXBlKCkpICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICB0aGlzLiRpdGVtcy5mb3JFYWNoKChpdGVtOiBWKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy4kY2hhbmdlcy5yb290LnJlbW92ZVJlZihpdGVtWyckY2hhbmdlcyddLnJlZklkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gY2xlYXIgaXRlbXNcbiAgICAgICAgdGhpcy4kaXRlbXMuY2xlYXIoKTtcblxuICAgICAgICB0aGlzLiRjaGFuZ2VzLm9wZXJhdGlvbih7IGluZGV4OiAwLCBvcDogT1BFUkFUSU9OLkNMRUFSIH0pO1xuXG4gICAgICAgIC8vIHRvdWNoIGFsbCBzdHJ1Y3R1cmVzIHVudGlsIHJlYWNoIHJvb3RcbiAgICAgICAgdGhpcy4kY2hhbmdlcy50b3VjaFBhcmVudHMoKTtcbiAgICB9XG5cbiAgICBoYXMgKGtleTogSykge1xuICAgICAgICByZXR1cm4gdGhpcy4kaXRlbXMuaGFzKGtleSk7XG4gICAgfVxuXG4gICAgZm9yRWFjaChjYWxsYmFja2ZuOiAodmFsdWU6IFYsIGtleTogSywgbWFwOiBNYXA8SywgVj4pID0+IHZvaWQpIHtcbiAgICAgICAgdGhpcy4kaXRlbXMuZm9yRWFjaChjYWxsYmFja2ZuKTtcbiAgICB9XG5cbiAgICBlbnRyaWVzICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmVudHJpZXMoKTtcbiAgICB9XG5cbiAgICBrZXlzICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmtleXMoKTtcbiAgICB9XG5cbiAgICB2YWx1ZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy52YWx1ZXMoKTtcbiAgICB9XG5cbiAgICBnZXQgc2l6ZSAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRpdGVtcy5zaXplO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzZXRJbmRleChpbmRleDogbnVtYmVyLCBrZXk6IHN0cmluZykge1xuICAgICAgICB0aGlzLiRpbmRleGVzLnNldChpbmRleCwga2V5KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0SW5kZXgoaW5kZXg6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gdGhpcy4kaW5kZXhlcy5nZXQoaW5kZXgpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRCeUluZGV4KGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGl0ZW1zLmdldCh0aGlzLiRpbmRleGVzLmdldChpbmRleCkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBkZWxldGVCeUluZGV4KGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy4kaW5kZXhlcy5nZXQoaW5kZXgpO1xuICAgICAgICB0aGlzLiRpdGVtcy5kZWxldGUoa2V5KTtcbiAgICAgICAgdGhpcy4kaW5kZXhlcy5kZWxldGUoaW5kZXgpO1xuICAgIH1cblxuICAgIHRvSlNPTigpIHtcbiAgICAgICAgY29uc3QgbWFwOiBhbnkgPSB7fTtcblxuICAgICAgICB0aGlzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIG1hcFtrZXldID0gKHR5cGVvZiAodmFsdWVbJ3RvSlNPTiddKSA9PT0gXCJmdW5jdGlvblwiKVxuICAgICAgICAgICAgICAgID8gdmFsdWVbJ3RvSlNPTiddKClcbiAgICAgICAgICAgICAgICA6IHZhbHVlO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbWFwO1xuICAgIH1cblxuICAgIC8vXG4gICAgLy8gRGVjb2RpbmcgdXRpbGl0aWVzXG4gICAgLy9cbiAgICBjbG9uZShpc0RlY29kaW5nPzogYm9vbGVhbik6IE1hcFNjaGVtYTxWPiB7XG4gICAgICAgIGxldCBjbG9uZWQ6IE1hcFNjaGVtYTtcblxuICAgICAgICBpZiAoaXNEZWNvZGluZykge1xuICAgICAgICAgICAgLy8gY2xpZW50LXNpZGVcbiAgICAgICAgICAgIGNsb25lZCA9IE9iamVjdC5hc3NpZ24obmV3IE1hcFNjaGVtYSgpLCB0aGlzKTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gc2VydmVyLXNpZGVcbiAgICAgICAgICAgIGNvbnN0IGNsb25lZCA9IG5ldyBNYXBTY2hlbWEoKTtcbiAgICAgICAgICAgIHRoaXMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZVsnJGNoYW5nZXMnXSkge1xuICAgICAgICAgICAgICAgICAgICBjbG9uZWQuc2V0KGtleSwgdmFsdWVbJ2Nsb25lJ10oKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvbmVkLnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNsb25lZDtcbiAgICB9XG5cbiAgICB0cmlnZ2VyQWxsICgpOiB2b2lkIHtcbiAgICAgICAgU2NoZW1hLnByb3RvdHlwZS50cmlnZ2VyQWxsLmFwcGx5KHRoaXMpO1xuICAgIH1cbn1cblxucmVnaXN0ZXJUeXBlKFwibWFwXCIsIHtcbiAgICBjb25zdHJ1Y3RvcjogTWFwU2NoZW1hLFxuICAgIGdldFByb3h5OiBnZXRNYXBQcm94eSxcbn0pOyJdfQ==